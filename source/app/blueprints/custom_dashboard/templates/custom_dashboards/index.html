{% extends "layouts/default.html" %}
{% block title %}Custom Dashboards{% endblock title %}

{% block stylesheets %}
  <link rel="stylesheet" href="/static/assets/css/select2.css">
  <link rel="stylesheet" href="/static/assets/css/custom_dashboards.css">
{% endblock stylesheets %}

{% block content %}
<div class="page-inner" id="customDashboardsRoot">
  {{ form.hidden_tag() }}
  <input type="hidden" id="currentCaseId" value="{{ case_id }}">
  <input type="hidden" id="dashboardCanShare" value="{% if can_share %}1{% else %}0{% endif %}">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Custom Dashboards</h3>
    <div class="btn-group">
      <button class="btn btn-outline-secondary btn-sm" id="dashboardHelpBtn" type="button"><i class="fas fa-question-circle mr-2"></i> Help</button>
      <button class="btn btn-primary btn-sm" id="createDashboardBtn" type="button"><i class="fas fa-plus mr-2"></i> New dashboard</button>
      <button class="btn btn-primary btn-sm" id="dashboardJsonImportBtn" type="button"><i class="fas fa-file-import mr-2"></i> Import</button>
    </div>
  </div>

  <div class="card mb-4" id="dashboardFiltersCard">
    <div class="card-header">
      <h5 class="mb-0">Filters</h5>
    </div>
    <div class="card-body">
      <form id="dashboardFilterForm" autocomplete="off">
        <div class="row">
            <div class="form-group col-md-4 col-xl-3">
                <label for="dashboardSelector" class="text-uppercase text-muted small font-weight-bold">Saved dashboards</label>
                <select class="custom-select" id="dashboardSelector">
                <option value="">Select a dashboard</option>
                </select>
            </div>
            <div class="text-muted small d-none" id="dashboardSelectorEmptyState">No custom dashboards yet. Create one to get started.</div>
          <div class="form-group col-md-4 col-xl-3">
            <label for="dashboardStart" class="small text-muted text-uppercase">Start</label>
            <input type="datetime-local" class="form-control" id="dashboardStart" name="start">
          </div>
          <div class="form-group col-md-4 col-xl-3">
            <label for="dashboardEnd" class="small text-muted text-uppercase">End</label>
            <input type="datetime-local" class="form-control" id="dashboardEnd" name="end">
          </div>
          <div class="form-group col-md-4 col-xl-3 d-flex align-items-end">
            <div class="w-100 mb-1">
              <div class="btn-group btn-group-sm w-100" role="group" aria-label="Filter actions">
                <button type="submit" class="btn btn-primary" id="dashboardApplyBtn">Apply</button>
                <button type="button" class="btn btn-outline-secondary" id="dashboardResetBtn">Reset</button>
              </div>
            </div>
          </div>
        </div>
  <div class="preset-range-container bg-light rounded px-2 py-2 mt-2">
          <div class="d-flex align-items-center mb-3">
            <h6 class="mb-0 text-uppercase text-muted small">Preset ranges</h6>
          </div>
          <div class="d-flex flex-wrap align-items-center">
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last15m" data-minutes="15">Last 15 minutes</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last1h" data-hours="1">Last hour</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last12h" data-hours="12">Last 12 hours</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last7d" data-days="7">Last 7 days</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last30d" data-days="30">Last 30 days</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last90d" data-days="90">Last 90 days</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last6m" data-months="6">Last 6 months</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last1y" data-years="1">Last 1 year</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last2y" data-years="2">Last 2 years</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last5y" data-years="5">Last 5 years</button>
          </div>
        </div>
      </form>
      <div class="text-danger small mt-2 d-none" id="dashboardFilterError"></div>
    </div>
  </div>

  <div class="card card-transparent mb-4" id="dashboardViewerCard">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <div class="d-flex align-items-center">
          <h5 class="card-title mb-0" id="selectedDashboardName">Select a dashboard</h5>
          <span class="badge badge-primary ml-2 d-none" id="selectedDashboardSharedBadge">Shared</span>
        </div>
        <small class="text-muted" id="dashboardViewerRange">--</small>
      </div>
      <div class="d-flex align-items-center">
        <div class="custom-control custom-checkbox mr-3 mb-0">
          <input type="checkbox" class="custom-control-input" id="dashboardAutoRefresh">
          <label class="custom-control-label" for="dashboardAutoRefresh">Auto-refresh</label>
        </div>
        <small class="text-muted mb-0" id="dashboardViewerStatus">Idle</small>
            <div class="dropdown mb-2 ml-2">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="dashboardToolsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Edit
            </button>
            <div class="dropdown-menu dropdown-menu-right shadow" aria-labelledby="dashboardToolsDropdown">
                <button type="button" class="dropdown-item" id="editDashboardBtn">Edit</button>
                <button type="button" class="dropdown-item" id="dashboardJsonExportBtn">Export</button>
                <div class="dropdown-divider"></div>
                <button type="button" class="dropdown-item text-danger" id="removeDashboardBtn">Delete</button>
            </div>
            </div>
      </div>
    </div>
    <div class="card-body">
      <div class="text-center my-4 d-none" id="dashboardViewerLoading">Loading...</div>
      <div class="text-center text-muted" id="dashboardViewerEmptyState">Choose a dashboard to display its widgets.</div>
      <div class="row" id="dashboardWidgets"></div>
    </div>
  </div>
</div>

<div class="modal" id="dashboardEditorModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xxl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dashboardEditorTitle">New dashboard</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="dashboardEditorForm">
          <input type="hidden" id="dashboardId" value="">
          <div class="form-group">
            <label for="dashboardName">Name</label>
            <input type="text" class="form-control" id="dashboardName" required>
          </div>
          <div class="form-group">
            <label for="dashboardDescription">Description</label>
            <textarea class="form-control" id="dashboardDescription" rows="2"></textarea>
          </div>
          <div class="form-group form-check" id="dashboardShareGroup">
            <input type="checkbox" class="form-check-input" id="dashboardIsShared"{% if not can_share %} disabled{% endif %}>
            <label class="form-check-label" for="dashboardIsShared">Share with team</label>
            {% if not can_share %}
              <small class="form-text text-muted">You do not have permission to share dashboards.</small>
            {% endif %}
          </div>
          <div class="d-flex justify-content-between align-items-center border rounded px-3 py-2 mb-3" id="dashboardEditorModeControls">
            <div>
              <h6 class="mb-0 text-uppercase text-muted small">Editor Mode</h6>
              <small class="text-muted">Switch between the visual builder and raw JSON at any time.</small>
            </div>
            <div class="btn-group btn-group-sm" id="dashboardEditorModeToggle" role="group" aria-label="Dashboard editor mode">
              <button type="button" class="btn btn-primary" data-mode="builder" id="dashboardModeBuilderBtn"><i class="fas fa-sliders-h mr-1"></i> Visual Builder</button>
              <button type="button" class="btn btn-outline-secondary" data-mode="json" id="dashboardModeJsonBtn"><i class="fas fa-code mr-1"></i> Raw JSON</button>
            </div>
          </div>

          <div id="dashboardBuilderPanel" class="dashboard-builder-panel">
            <p class="text-muted small mb-3" id="dashboardBuilderEmptyHint">Add sections to organise widgets. Sections can display a title and optional divider bar to visually separate groups of widgets.</p>
            <div id="dashboardSectionsContainer" class="dashboard-builder-sections"></div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                <small class="text-muted">Sections help recreate analytic layouts.</small>
              </div>
              <div>
                <button type="button" class="btn btn-outline-primary btn-sm" id="addSectionBtn"><i class="fas fa-layer-group mr-1"></i>Add section</button>
              </div>
            </div>
          </div>

          <div id="dashboardJsonPanel" class="dashboard-json-panel d-none">
            <div class="border rounded" id="dashboardEditorJson" style="min-height: 320px; height: 320px;"></div>
            <textarea class="form-control d-none" id="dashboardEditorJsonTextarea" rows="12" spellcheck="false"></textarea>
            <small class="form-text text-muted">Edit the full dashboard payload. Switch back to the visual builder to continue using the guided UI.</small>
          </div>

          <datalist id="dashboardBuilderColumnOptions">
            <option value="alerts.alert_id">
            <option value="alerts.alert_uuid">
            <option value="alerts.alert_title">
            <option value="alerts.alert_source">
            <option value="alerts.alert_source_ref">
            <option value="alerts.alert_description">
            <option value="alerts.alert_creation_time">
            <option value="alerts.alert_source_event_time">
            <option value="alerts.alert_customer_id">
            <option value="alerts.alert_resolution_status_id">
            <option value="alerts.alert_status_id">
            <option value="alerts.alert_severity_id">
            <option value="alerts.alert_classification_id">
            <option value="client.client_id">
            <option value="client.name">
            <option value="alert_resolution_status.resolution_status_id">
            <option value="alert_resolution_status.resolution_status_name">
            <option value="alert_status.status_id">
            <option value="alert_status.status_name">
            <option value="severities.severity_id">
            <option value="severities.severity_name">
            <option value="case_classification.id">
            <option value="case_classification.name">
            <option value="case_classification.name_expanded">
            <option value="cases.case_id">
            <option value="cases.name">
          </datalist>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" id="dashboardDeleteBtn" style="display:none;">Delete</button>
        <button type="button" class="btn btn-primary" id="dashboardSaveBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="dashboardHelpModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Custom Dashboard Reference</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
    <p class="mb-3">For each widget, paste JSON describing the <code>fields</code> array. Provide one object per field you want to display or aggregate.</p>
    <p class="mb-3">Need a quick start? Use the "Add from template" dropdown in each section or review <code>static/assets/js/iris/custom_dashboards/widget_presets.json</code> for the preset definitions.</p>
        <h6>Field attributes</h6>
        <ul>
          <li><code>table</code> (required): one of the allowed tables below.</li>
          <li><code>column</code> (required): column name from that table.</li>
          <li><code>aggregation</code> (optional): <code>count</code>, <code>sum</code>, <code>avg</code>, <code>min</code>, or <code>max</code>.</li>
          <li><code>alias</code> (optional): label used in the chart or value output.</li>
        </ul>
        <h6>Allowed tables and columns</h6>
        <div class="table-responsive mb-3">
          <table class="table table-sm table-striped mb-0">
            <thead>
              <tr>
                <th style="width: 180px;">Table</th>
                <th>Columns</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>alerts</code></td>
                <td><code>alert_id</code>, <code>alert_uuid</code>, <code>alert_title</code>, <code>alert_source</code>, <code>alert_source_ref</code>, <code>alert_description</code>, <code>alert_creation_time</code>, <code>alert_source_event_time</code>, <code>alert_customer_id</code>, <code>alert_resolution_status_id</code>, <code>alert_status_id</code>, <code>alert_severity_id</code>, <code>alert_classification_id</code></td>
              </tr>
              <tr>
                <td><code>client</code></td>
                <td><code>client_id</code>, <code>name</code></td>
              </tr>
              <tr>
                <td><code>alert_resolution_status</code></td>
                <td><code>resolution_status_id</code>, <code>resolution_status_name</code></td>
              </tr>
              <tr>
                <td><code>alert_status</code></td>
                <td><code>status_id</code>, <code>status_name</code></td>
              </tr>
              <tr>
                <td><code>severities</code></td>
                <td><code>severity_id</code>, <code>severity_name</code></td>
              </tr>
              <tr>
                <td><code>case_classification</code></td>
                <td><code>id</code>, <code>name</code>, <code>name_expanded</code></td>
              </tr>
              <tr>
                <td><code>cases</code></td>
                <td><code>case_id</code>, <code>name</code></td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="mb-3">You can optionally include <code>filters</code>, <code>group_by</code>, or <code>options</code> objects alongside <code>fields</code> if your widget requires them.</p>
        <h6>Example fields payload</h6>
        <pre class="bg-light p-2"><code>[
  {
    "table": "alerts",
    "column": "alert_id",
    "aggregation": "count",
    "alias": "alert_count"
  },
  {
    "table": "client",
    "column": "name",
    "alias": "client_name"
  }
]</code></pre>
  <h6 class="mt-4">Widget options</h6>
  <p class="mb-2">Set the keys below inside each widget's <code>options</code> object to control layout, data shaping, and styling.</p>
  <div class="table-responsive mb-3">
    <table class="table table-sm table-striped mb-0">
      <thead>
        <tr>
          <th style="width: 180px;">Option</th>
          <th>Description</th>
          <th style="width: 200px;">Example values</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>chart_type</code></td>
          <td>Set on the widget root (outside <code>options</code>) to choose the visualization.</td>
          <td><code>"line"</code>, <code>"bar"</code>, <code>"pie"</code>, <code>"number"</code>, <code>"percentage"</code>, <code>"table"</code></td>
        </tr>
        <tr>
          <td><code>display</code> / <code>display_mode</code></td>
          <td>Controls table value formatting.</td>
          <td><code>"number"</code>, <code>"percentage"</code>, <code>"number_percentage"</code></td>
        </tr>
        <tr>
          <td><code>widget_size</code></td>
          <td>Overrides the widget column width. Provide Bootstrap grid classes (e.g., <code>col-md-6</code>) or short forms like <code>md-6</code> which auto-expand.</td>
          <td><code>"col-md-6"</code>, <code>"col-lg-4"</code></td>
        </tr>
        <tr>
          <td><code>total_label</code></td>
          <td>Custom label for table summary rows and totals.</td>
          <td><code>"Grand total"</code></td>
        </tr>
        <tr>
          <td><code>time_column</code></td>
          <td>Overrides the timestamp column used for range filtering (<code>table.column</code> format).</td>
          <td><code>"cases.created_at"</code></td>
        </tr>
        <tr>
          <td><code>sort</code></td>
          <td>Sorts aggregated results by the first metric or group.</td>
          <td><code>"asc"</code>, <code>"desc"</code></td>
        </tr>
        <tr>
          <td><code>limit</code></td>
          <td>Limits the number of grouped rows returned (must be a positive integer).</td>
          <td><code>10</code></td>
        </tr>
        <tr>
          <td><code>color</code></td>
          <td>Single color applied to the series or number widgets.</td>
          <td><code>"#4e73df"</code></td>
        </tr>
        <tr>
          <td><code>colors</code></td>
          <td>Palette for charts; accepts an array or comma-separated list.</td>
          <td><code>["#4e73df", "#1cc88a"]</code></td>
        </tr>
        <tr>
          <td><code>fill</code></td>
          <td>Fills the area under line charts when <code>true</code>.</td>
          <td><code>true</code></td>
        </tr>
        <tr>
          <td><code>label_max_length</code></td>
          <td>Truncates long axis labels to the given character count.</td>
          <td><code>32</code></td>
        </tr>
        <tr>
          <td><code>legend_position</code></td>
          <td>Moves the chart legend.</td>
          <td><code>"top"</code>, <code>"right"</code>, <code>"bottom"</code>, <code>"left"</code></td>
        </tr>
        <tr>
          <td><code>thresholds</code></td>
          <td>Optional list of conditional styles for number and percentage widgets. Each entry supports <code>mode</code> (<code>"above"</code>, <code>"below"</code>, <code>"between"</code>, <code>"equal"</code>), <code>value</code>, optional <code>end_value</code>, <code>color</code>, and <code>label</code>.</td>
          <td><code>[{"mode":"above","value":40,"color":"#dc3545"}]</code></td>
        </tr>
      </tbody>
    </table>
  </div>
  <p class="mb-3">Dataset entries accept the same <code>color</code> and <code>colors</code> keys to override individual series, and you can provide <code>total</code> to lock in percentage calculations. Percentages are automatically calculated when totals are provided or inferred.</p>
  <h6>Example: False Positive Rate KPI</h6>
  <pre class="bg-light p-2"><code>{
  "name": "False Positive Rate KPI",
  "chart_type": "percentage",
  "fields": [
    {
      "table": "alerts",
      "column": "alert_id",
      "aggregation": "count",
      "alias": "total_alerts"
    },
    {
      "table": "alerts",
      "column": "alert_id",
      "aggregation": "count",
      "alias": "false_positive_alerts",
      "filter": {
        "table": "alert_resolution_status",
        "column": "resolution_status_name",
        "operator": "eq",
        "value": "False Positive"
      }
    }
  ],
  "options": {
    "widget_size": "col-lg-4",
    "display_mode": "number_percentage",
    "percentage_numerator": "false_positive_alerts",
    "percentage_denominator": "total_alerts",
    "thresholds": [
      {"mode": "above", "value": 40, "color": "#dc3545", "label": "Critical"},
      {"mode": "between", "value": 20, "end_value": 40, "color": "#fd7e14", "label": "Monitor"},
      {"mode": "below", "value": 20, "color": "#1cc88a", "label": "Healthy"}
    ]
  }
}</code></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="dashboardJsonModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Dashboard JSON Tools</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="small text-muted">Import, export, or edit dashboards directly via JSON. Load an existing dashboard, update it, or paste a new configuration below.</p>
  <div id="dashboardJsonEditor" class="border rounded d-none" style="min-height: 320px; height: 320px;"></div>
  <textarea class="form-control" id="dashboardJsonTextarea" rows="12" spellcheck="false"></textarea>
        <small class="form-text text-muted">Expected keys: <code>name</code>, <code>description</code>, <code>is_shared</code>, and <code>widgets</code>. Widget definitions mirror the examples in the help modal.</small>
        <input type="file" id="dashboardJsonFileInput" accept="application/json" class="d-none">
      </div>
      <div class="modal-footer flex-wrap">
        <div class="btn-group mr-auto mb-2" role="group" aria-label="JSON actions">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="dashboardJsonDownloadBtn">Download</button>
        </div>
        <div class="btn-group ml-2 mb-2" role="group" aria-label="JSON actions">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="dashboardJsonImportFileBtn">Load from file</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="dashboardJsonCreateBtn">Import as new</button>
            <button type="button" class="btn btn-sm btn-outline-success" id="dashboardJsonUpdateBtn">Update current dashboard</button>
        </div>
        <div class="btn-group ml-auto mb-2" role="group" aria-label="JSON actions">
          <button type="button" class="btn btn-sm btn-outline-danger" id="dashboardJsonClearBtn">Clear</button>
          <button type="button" class="btn btn-sm btn-outline-danger" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block javascripts %}
  <script src="/static/assets/js/plugin/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="/static/assets/js/plugin/ace/src-noconflict/ext-language_tools.js" type="text/javascript" charset="utf-8"></script>
  <script src="/static/assets/js/core/charts.js"></script>
  <script src="/static/assets/js/iris/custom_dashboards/custom_dashboards.js"></script>
{% endblock javascripts %}
