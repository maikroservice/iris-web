{% extends "layouts/default.html" %}
{% block title %}Custom Dashboards{% endblock title %}

{% block stylesheets %}
  <link rel="stylesheet" href="/static/assets/css/select2.css">
  <link rel="stylesheet" href="/static/assets/css/custom_dashboards.css">
{% endblock stylesheets %}

{% block content %}
<div class="page-inner" id="customDashboardsRoot">
  {{ form.hidden_tag() }}
  <input type="hidden" id="currentCaseId" value="{{ case_id }}">
  <input type="hidden" id="dashboardCanShare" value="{% if can_share %}1{% else %}0{% endif %}">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Custom Dashboards</h3>
    <div class="btn-group">
      <button class="btn btn-outline-secondary btn-sm" id="dashboardHelpBtn" type="button">Help</button>
      <button class="btn btn-primary btn-sm" id="createDashboardBtn" type="button">New dashboard</button>
    </div>
  </div>

  <div class="card mb-4" id="dashboardFiltersCard">
    <div class="card-header">
      <h5 class="mb-0">Filters</h5>
    </div>
    <div class="card-body">
      <form id="dashboardFilterForm" autocomplete="off">
        <div class="row">
            <div class="form-group col-md-4 col-xl-3">
                <label for="dashboardSelector" class="text-uppercase text-muted small font-weight-bold">Saved dashboards</label>
                <select class="custom-select" id="dashboardSelector">
                <option value="">Select a dashboard</option>
                </select>
            </div>
            <div class="text-muted small d-none" id="dashboardSelectorEmptyState">No custom dashboards yet. Create one to get started.</div>
          <div class="form-group col-md-4 col-xl-3">
            <label for="dashboardStart" class="small text-muted text-uppercase">Start</label>
            <input type="datetime-local" class="form-control" id="dashboardStart" name="start">
          </div>
          <div class="form-group col-md-4 col-xl-3">
            <label for="dashboardEnd" class="small text-muted text-uppercase">End</label>
            <input type="datetime-local" class="form-control" id="dashboardEnd" name="end">
          </div>
          <div class="form-group col-md-4 col-xl-3 d-flex align-items-end">
            <div class="w-100 mb-1">
              <div class="btn-group btn-group-sm w-100" role="group" aria-label="Filter actions">
                <button type="submit" class="btn btn-primary" id="dashboardApplyBtn">Apply</button>
                <button type="button" class="btn btn-outline-secondary" id="dashboardResetBtn">Reset</button>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-light rounded px-2 py-2 mt-2">
          <div class="d-flex align-items-center mb-3">
            <h6 class="mb-0 text-uppercase text-muted small">Preset ranges</h6>
          </div>
          <div class="d-flex flex-wrap align-items-center">
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last15m" data-minutes="15">Last 15 minutes</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last1h" data-hours="1">Last hour</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last12h" data-hours="12">Last 12 hours</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last7d" data-days="7">Last 7 days</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last30d" data-days="30">Last 30 days</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last90d" data-days="90">Last 90 days</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last6m" data-months="6">Last 6 months</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last1y" data-years="1">Last 1 year</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last2y" data-years="2">Last 2 years</button>
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill shadow-sm mr-2 mb-2 dashboard-quick-range" data-range-key="last5y" data-years="5">Last 5 years</button>
          </div>
        </div>
      </form>
      <div class="text-danger small mt-2 d-none" id="dashboardFilterError"></div>
    </div>
  </div>

  <div class="card card-transparent mb-4" id="dashboardViewerCard">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <div class="d-flex align-items-center">
          <h5 class="card-title mb-0" id="selectedDashboardName">Select a dashboard</h5>
          <span class="badge badge-primary ml-2 d-none" id="selectedDashboardSharedBadge">Shared</span>
        </div>
        <small class="text-muted" id="dashboardViewerRange">--</small>
      </div>
      <div class="d-flex align-items-center">
        <div class="custom-control custom-switch mr-3 mb-0">
          <input type="checkbox" class="custom-control-input" id="dashboardAutoRefresh">
          <label class="custom-control-label" for="dashboardAutoRefresh">Auto-refresh</label>
        </div>
        <small class="text-muted mb-0" id="dashboardViewerStatus">Idle</small>
            <div class="dropdown mb-2 ml-2">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="dashboardToolsDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Edit
            </button>
            <div class="dropdown-menu dropdown-menu-right shadow" aria-labelledby="dashboardToolsDropdown">
                <button type="button" class="dropdown-item" id="editDashboardBtn">Edit</button>
                <button type="button" class="dropdown-item" id="dashboardJsonEditBtn">Edit as JSON</button>
                <button type="button" class="dropdown-item" id="dashboardJsonExportBtn">Export</button>
                <div class="dropdown-divider"></div>
                <button type="button" class="dropdown-item" id="dashboardJsonImportBtn">Import</button>
                <div class="dropdown-divider"></div>
                <button type="button" class="dropdown-item text-danger" id="removeDashboardBtn">Delete</button>
            </div>
            </div>
      </div>
    </div>
    <div class="card-body">
      <div class="text-center my-4 d-none" id="dashboardViewerLoading">Loading...</div>
      <div class="text-center text-muted" id="dashboardViewerEmptyState">Choose a dashboard to display its widgets.</div>
      <div class="row" id="dashboardWidgets"></div>
    </div>
  </div>
</div>

<div class="modal" id="dashboardEditorModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dashboardEditorTitle">New dashboard</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="dashboardEditorForm">
          <input type="hidden" id="dashboardId" value="">
          <div class="form-group">
            <label for="dashboardName">Name</label>
            <input type="text" class="form-control" id="dashboardName" required>
          </div>
          <div class="form-group">
            <label for="dashboardDescription">Description</label>
            <textarea class="form-control" id="dashboardDescription" rows="2"></textarea>
          </div>
          <div class="form-group form-check" id="dashboardShareGroup">
            <input type="checkbox" class="form-check-input" id="dashboardIsShared"{% if not can_share %} disabled{% endif %}>
            <label class="form-check-label" for="dashboardIsShared">Share with team</label>
            {% if not can_share %}
              <small class="form-text text-muted">You do not have permission to share dashboards.</small>
            {% endif %}
          </div>
          <div id="widgetList"></div>
          <button type="button" class="btn btn-outline-primary btn-sm" id="addWidgetBtn">Add widget</button>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-danger" id="dashboardDeleteBtn" style="display:none;">Delete</button>
        <button type="button" class="btn btn-primary" id="dashboardSaveBtn">Save</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="dashboardHelpModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Custom Dashboard Reference</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="mb-3">For each widget, paste JSON describing the <code>fields</code> array. Provide one object per field you want to display or aggregate.</p>
        <h6>Field attributes</h6>
        <ul>
          <li><code>table</code> (required): one of the allowed tables below.</li>
          <li><code>column</code> (required): column name from that table.</li>
          <li><code>aggregation</code> (optional): <code>count</code>, <code>sum</code>, <code>avg</code>, <code>min</code>, or <code>max</code>.</li>
          <li><code>alias</code> (optional): label used in the chart or value output.</li>
        </ul>
        <h6>Allowed tables and columns</h6>
        <div class="table-responsive mb-3">
          <table class="table table-sm table-striped mb-0">
            <thead>
              <tr>
                <th style="width: 180px;">Table</th>
                <th>Columns</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><code>alerts</code></td>
                <td><code>alert_id</code>, <code>alert_uuid</code>, <code>alert_title</code>, <code>alert_source</code>, <code>alert_source_ref</code>, <code>alert_description</code>, <code>alert_creation_time</code>, <code>alert_source_event_time</code>, <code>alert_customer_id</code>, <code>alert_resolution_status_id</code>, <code>alert_status_id</code>, <code>alert_severity_id</code>, <code>alert_classification_id</code></td>
              </tr>
              <tr>
                <td><code>client</code></td>
                <td><code>client_id</code>, <code>name</code></td>
              </tr>
              <tr>
                <td><code>alert_resolution_status</code></td>
                <td><code>resolution_status_id</code>, <code>resolution_status_name</code></td>
              </tr>
              <tr>
                <td><code>alert_status</code></td>
                <td><code>status_id</code>, <code>status_name</code></td>
              </tr>
              <tr>
                <td><code>severities</code></td>
                <td><code>severity_id</code>, <code>severity_name</code></td>
              </tr>
              <tr>
                <td><code>case_classification</code></td>
                <td><code>id</code>, <code>name</code>, <code>name_expanded</code></td>
              </tr>
              <tr>
                <td><code>cases</code></td>
                <td><code>case_id</code>, <code>name</code></td>
              </tr>
            </tbody>
          </table>
        </div>
        <p class="mb-3">You can optionally include <code>filters</code>, <code>group_by</code>, or <code>options</code> objects alongside <code>fields</code> if your widget requires them.</p>
        <h6>Example fields payload</h6>
        <pre class="bg-light p-2"><code>[
  {
    "table": "alerts",
    "column": "alert_id",
    "aggregation": "count",
    "alias": "alert_count"
  },
  {
    "table": "client",
    "column": "name",
    "alias": "client_name"
  }
]</code></pre>
  <h6 class="mt-4">Widget options</h6>
  <p class="mb-2">Use <code>chart_type</code> to choose the visualization: <code>line</code>, <code>bar</code>, <code>pie</code>, <code>number</code>, <code>percentage</code>, or <code>table</code>. Table widgets support <code>options.display</code> (or <code>options.display_mode</code>) set to <code>number</code>, <code>percentage</code>, or <code>number_percentage</code> to control how values are rendered. Use <code>options.size</code> to override the column width (e.g., <code>md-6</code>, <code>col-md-4</code>), and <code>options.total_label</code> to customize the summary row caption.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="dashboardJsonModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Dashboard JSON Tools</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p class="small text-muted">Import, export, or edit dashboards directly via JSON. Load an existing dashboard, update it, or paste a new configuration below.</p>
        <textarea class="form-control" id="dashboardJsonTextarea" rows="12" spellcheck="false"></textarea>
        <small class="form-text text-muted">Expected keys: <code>name</code>, <code>description</code>, <code>is_shared</code>, and <code>widgets</code>. Widget definitions mirror the examples in the help modal.</small>
        <input type="file" id="dashboardJsonFileInput" accept="application/json" class="d-none">
      </div>
      <div class="modal-footer flex-wrap">
        <div class="btn-group mr-auto mb-2" role="group" aria-label="JSON actions">
          <button type="button" class="btn btn-outline-primary" id="dashboardJsonLoadBtn">Load selected</button>
          <button type="button" class="btn btn-outline-secondary" id="dashboardJsonDownloadBtn">Download</button>
          <button type="button" class="btn btn-outline-info" id="dashboardJsonImportFileBtn">Import file</button>
        </div>
        <div class="btn-group mb-2" role="group" aria-label="JSON apply">
          <button type="button" class="btn btn-success" id="dashboardJsonCreateBtn">Import as new</button>
          <button type="button" class="btn btn-primary" id="dashboardJsonUpdateBtn">Update selected</button>
          <button type="button" class="btn btn-outline-danger" id="dashboardJsonClearBtn">Clear</button>
        </div>
        <button type="button" class="btn btn-secondary mb-2" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock content %}

{% block javascripts %}
  <script src="/static/assets/js/core/charts.js"></script>
  <script src="/static/assets/js/iris/custom_dashboards/custom_dashboards.js"></script>
{% endblock javascripts %}
